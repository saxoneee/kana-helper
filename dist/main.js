!function(){var e=$("#input"),a=$("#kana"),n=null,t=null,i=null,u={},o=null,r=null;function s(e,a,n,t){for(var i=$('<div class="kana-key"></div>'),u={0:"main",1:"top",2:"right",3:"bottom",4:"left"},o=0;o<t.length;o++){var r=t[o];if(r){var s=$('<div class="'+u[o]+'" data-pos="'+o+'" data-keycode="'+e+'" data-data-key="'+r[a]+'">'+r[n]+"</div>");i.append(s)}}return i}function l(e,a){var n=t[e];if(n)for(var i=0;i<n.length;i++){var u=n[i];if(u&&u.keyCode&&parseInt(u.keyCode)===a)return!0}return!1}function d(e,a){switch(e){case"input":r=u[a],o=a,i=r[0];var n=$(".kana-key").find('.main[data-keycode="'+a+'"]');n.parent().addClass("in-use"),n.addClass("in-use");break;case"control":var s=t.control.filter((function(e){return parseInt(e.keyCode)===a}));if(s.length>0){var l=!1;switch((s=s[0]).keyValue){case"top":i=r[1],l=!0;break;case"right":i=r[2],l=!0;break;case"bottom":i=r[3],l=!0;break;case"left":i=r[4],l=!0}if(l){var d=$(".kana-key").find("."+s.keyValue+'[data-keycode="'+o+'"]');d.parent().find(".in-use").removeClass("in-use"),d.addClass("in-use")}}}}function k(a,u){switch(a){case"input":if((p=$(".kana-key").find('[data-keycode="'+u+'"]').parent()).removeClass("in-use"),p.find(".in-use").removeClass("in-use"),i){switch(i.r){case"daku":case"daku2":if((v=e.prop("selectionStart"))<=0)break;var s=e.val()[v-1];for(var l in n){var d=n[l],k="daku2"===i.r&&d["daku2-h"]?"daku2-h":"daku-h";d.h===s&&d[k]&&n[d[k]]&&(f(e[0]),c(e[0],n[d[k]].h))}break;case"handaku":var v;if((v=e.prop("selectionStart"))<=0)break;for(var l in s=e.val()[v-1],n)(d=n[l]).h===s&&d["handaku-h"]&&n[d["handaku-h"]]&&(f(e[0]),c(e[0],n[d["handaku-h"]].h));break;default:c(e[0],i.h)}i=null,o=null,r=null}break;case"control":if(!r)break;var h=t.control.filter((function(e){return parseInt(e.keyCode)===u}));if(h.length>0&&(h=h[0],-1!==["top","right","bottom","left"].indexOf(h.keyValue))){i=r[0];var p,y=$(".kana-key").find('.main[data-keycode="'+o+'"]');(p=y.parent()).find(".in-use").removeClass("in-use"),y.addClass("in-use")}}}function c(e,a){if(document.selection)e.focus(),sel=document.selection.createRange(),sel.text=a;else if(e.selectionStart||"0"==e.selectionStart){var n=e.selectionStart,t=e.selectionEnd;e.value=e.value.substring(0,n)+a+e.value.substring(t,e.value.length),e.selectionStart=n+a.length,e.selectionEnd=n+a.length}else e.value+=a}function f(e){if(e.selectionStart>"0"){var a=e.selectionStart-1,n=e.selectionEnd;e.value=e.value.substring(0,a)+e.value.substring(n,e.value.length),e.selectionStart=a,e.selectionEnd=a}}$.when($.get("data/kana.json"),$.get("data/keybinding.json")).done((function(i,o){var r,c;n=function(e,a){for(var n={},t=0;t<a.length;t++)n[a[t].r.replace(/\s/,"_")]=a[t];return n}(0,i[0]),t=o[0],function(){var e=[];u[t.input[0].keyCode]=[n.A,n.U,n.E,n.O,n.I],u[t.input[1].keyCode]=[n.Ka,n.Ku,n.Ke,n.Ko,n.Ki],u[t.input[2].keyCode]=[n.Sa,n.Su,n.Se,n.So,n.Shi],u[t.input[3].keyCode]=[n.Ta,n.Tsu,n.Te,n.To,n.Chi],u[t.input[4].keyCode]=[n.Na,n.Nu,n.Ne,n.No,n.Ni],u[t.input[5].keyCode]=[n.Ha,n.Fu,n.He,n.Ho,n.Hi],u[t.input[6].keyCode]=[n.Ma,n.Mu,n.Me,n.Mo,n.Mi],u[t.input[7].keyCode]=[n.Ya,n.Yu,n.klammer_zu,n.Yo,n.klammer_auf],u[t.input[8].keyCode]=[n.Ra,n.Ru,n.Re,n.Ro,n.Ri],u[t.input[9].keyCode]=[n.daku2,n.handaku,n.punkt,n.komma,n.daku],u[t.input[10].keyCode]=[n.Wa,n.N,n.choonpu,n.namidasshu,n.Wo];for(var i=0;i<t.input.length;i++){var o=t.input[i];i>0&&i%3==0&&e.push($("<br>")),e.push(s(o.keyCode,"r","h",u[o.keyCode]))}a.append(e)}(),r=!1,c=!1,e.on("keydown",(function(e){var a=e.which;if(l("input",a))return r||(r=a,d("input",a)),!1;if(l("control",a)){if(!r)return;return c||(c=a,d("control",a)),!1}})),e.on("keyup",(function(e){var a=e.which;r===a&&(k("input",a),r=!1),c===a&&(k("control",a),c=!1)}))}))}();